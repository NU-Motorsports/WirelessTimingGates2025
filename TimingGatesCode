#include <LiquidCrystal.h>
int modeButton = 5;//Button Pin
int Sensor_0 = 3; //Sensor pin  
int Sensor_1 = 4; //Sensor pin  
int start_sensor; // Used to track which sesnor started 
int end_sensor; //Used to track which sensor must end
unsigned long StartTrigger = 0; //Start time
unsigned long timeBetween = 0; //Time between triggers(output time)
bool Timer_Started = false; //checks whether the timer is running
const int rs = 13, en = 12, d4 = 11, d5 = 10, d6 = 9, d7 = 8; //Ripped code from online for the LCD initialization so I got no clue. (Fuck reading documentation)
LiquidCrystal lcd(rs, en, d4, d5, d6, d7);//initializes the LCD screen as an object with the correct pin assignments.
float saved_time = 0; //previously logged time
int current_Mode = 0; //There will be two modes: 0 is timing gates, 1 will be the Lap timer

void setup() {
  Serial.begin(9600);
  pinMode(Sensor_1, INPUT_PULLUP);
  pinMode(Sensor_0, INPUT_PULLUP);
  lcd.begin(16, 2); //starts the LCD screen as a 16 by 2 display(16 characters wide 2 high)
  pinMode(modeButton, INPUT_PULLUP);
  lcd.setCursor(0, 0);
  lcd.print("Gates Ready.");
}

void loop() {
  ChangeState() //Checks if the state needs to be changed
  if (!current_Mode){ //checks if its in the timing gates mode
    TimingGates(); //Timing gates function
  }
  else {
    LapTime(); //lap time function
  }
  

}

void TimingGates(){ //Timing Gates function 
  if (digitalRead(Sensor_0) == LOW && !Timer_Started){ //Check if currently timing and if sensor 0 is tripped
    TimerStarted();
    start_sensor = Sensor_0;
    end_sensor = Sensor_1;

  }
  else if(digitalRead(Sensor_1) == LOW && !Timer_Started){ //If not currently timing and sesnor 1 is tripped start the  timer and take needed variables. Same as above if statement
    TimerStarted();
    start_sensor = Sensor_1;
    end_sensor = Sensor_0;
  }

  if (digitalRead(end_sensor) == LOW && Timer_Started){ //if the end sensor is tripped while the timer is running run the end function
    TimerEnded();
    delay(500);
    lcd.setCursor(0, 0);
    lcd.print("Gates Ready.");
  }

}
void ModeChangeCleanup(){ //Makes sure there arent any unresolved variables
  lcd.clear(); //So the LCD doesnt have incorrect information
  Timer_Started = false; //
  delay(500); //gives half a second for person to release the button 
}



void ChangeState(){//changes the state
  if (!digitalRead(modeButton)){ //If the button is pressed(pullup so button is active low
    mode = (mode + 1) % 2;//modulo to make mode only be either 1 or 0
  }
  ModeChangeCleanup(); //Cleans up any changed variables and gives half a second to Srelease the button
  lcd.setCursor(0, 0);
  if (mode == 0){
    lcd.print("Gates Ready.");
  }
  else{
    lcd.print("Lap Time Ready.");
  }
}

void LapTime(){ //Handles the lap timer
  if(digitalRead(Sensor_1) == LOW && !Timer_Started){
    TimerStarted();
    delay(1000);
  }
  if(digitalRead(Sensor_1) == LOW && !Timer_Started){
    TimerEnded();
    TimerStarted();
  }
}
void TimerStarted() {//For when the timer is started
    Timer_Started = true; //Shows that the timing is running
    StartTrigger = millis(); //Sets the start timer value for later calculation
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Active."); //Clears and writes to the LCD that it is currently running
}

void TimerEnded() { //Runs when the timer ends
    Timer_Started = false;
    unsigned long now = millis();
    timeBetween = now - StartTrigger;
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Not Active.");
    lcd.setCursor(0, 1);
    saved_time = (float)timeBetween/1000;
    lcd.print(saved_time);
    lcd.print(" Seconds");
}
// if (Timer_Started){
//   unsigned short now = millis();
  //   timeBetween = now - StartTrigger;
  //   float time_float = (float)timeBetween/1000;
  //   lcd.setCursor(0, 0);
  //   lcd.print(time_float);
  //   lcd.print(" Seconds");

  // }    
//void LapTimeCleanup(){ //Makes sure there arent any unresolved variables
//  delay(500);//Half a second for someone to release the button after pressing
//}

    // if (saved_time != 0){
    //   lcd.setCursor(0, 2);
    //   lcd.print("Prev. time: ");
    //   lcd.print(saved_time);
    // lcd.setCursor(0, 0);
    // // lcd.print("0 Seconds");
    // }
